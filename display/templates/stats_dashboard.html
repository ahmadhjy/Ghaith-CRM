<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title> Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/stats_dashboard.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container mt-4">

        <!-- First Section: Leads Count Chart -->
        <div class="section">
            <h3 class="section-title">Ghaith Leads: All Time Overview</h3>
            <canvas id="leadsCountChart"></canvas>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    const leadsCountData = {
                        labels: {{ status_labels|safe }},
                        datasets: [{
                            label: 'Leads Count',
                            data: {{ status_counts|safe }},
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                'rgba(100, 255, 218, 0.2)',
                                'rgba(204, 204, 255, 0.2)',
                                'rgba(0, 128, 128, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(100, 255, 218, 1)',
                                'rgba(204, 204, 255, 1)',
                                'rgba(0, 128, 128, 1)'
                            ],
                            borderWidth: 1
                        }]
                    };

                    const leadsCountConfig = {
                        type: 'bar',
                        data: leadsCountData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    };

                    const leadsCountChart = new Chart(
                        document.getElementById('leadsCountChart'),
                        leadsCountConfig
                    );
                });
            </script>
        </div>

        <!-- Second Section: General Stats -->
        <div class="section">
            <h3 class="section-title">Travel Performance For The Year of {{ current_year }}</h3>
            <canvas id="generalStatsChart"></canvas>

            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    const generalStatsData = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [
                            {
                                label: 'Sold over Modified',
                                data: {{ sold_over_modified|safe }},
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Sold over Negotiation',
                                data: {{ sold_over_negotiation|safe }},
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Unqualified over Modified',
                                data: {{ unqualified_over_modified|safe }},
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    };

                    const config = {
                        type: 'bar',
                        data: generalStatsData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    };

                    const generalStatsChart = new Chart(
                        document.getElementById('generalStatsChart'),
                        config
                    );
                });
            </script>
        </div>

        <!-- Third Section: Target Progress -->
        <div class="section">
            <form method="get" action="{% url 'stats_dashboard' %}" class="form-inline justify-content-center mb-3">
                <label for="month">Select Month:</label>
                <select name="month" id="month" class="form-control mx-2">
                    {% for month in month_list %}
                        <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>{{ month }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Filter</button>
            </form>
            <h3 class="section-title">Ghaith Monthly Target Progress During {{ selected_month }}</h3>
            <div class="card p-3 mb-4 shadow-sm">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ progress_percentage }}%;" aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        <span class="progress-text">{{ progress_percentage|floatformat:2 }}% ({{ achieved_profit }}$ out of {{ monthly_target }}$)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fourth Section: Employee Stats -->
        <div class="section">
            <h3 class="section-title">Ghaith Employee Stats for {{ selected_month }}</h3>
            <table class="table table-striped table-bordered shadow-sm">
                <thead class="thead-custom">
                    <tr>
                        <th>Employee</th>
                        <th>Sold over Modified</th>
                        <th>% of Team Sales</th>
                        <th>Leads Overtaken</th>
                        <th>Target Achieved</th>
                        <th>Sent Offers</th>
                        <th>Sold Offers</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in employee_stats|dictsortreversed:"percentage_of_total_team_sales" %}
                    <tr class="{% if stat.percentage_sold_over_modified < 20 %}low-percentage{% elif stat.percentage_sold_over_modified < 60 %}medium-percentage{% else %}high-percentage{% endif %} {% if forloop.first %}highlight{% endif %}">
                        <td>{{ stat.employee }} {% if forloop.first %}<i class="fas fa-crown crown-icon"></i>{% endif %}</td>
                        <td class="{% if stat.percentage_sold_over_modified < 20 %}low-text{% elif stat.percentage_sold_over_modified < 60 %}medium-text{% else %}high-text{% endif %}">{{ stat.percentage_sold_over_modified|floatformat:2 }}%</td>
                        <td>{{ stat.percentage_of_total_team_sales|floatformat:2 }}%</td>
                        <td>{{ stat.overtaken_leads }}</td>
                        <td>
                            {% if stat.user_progress_percentage == 'NA' %}
                                NA
                            {% else %}
                                {{ stat.user_progress_percentage|floatformat:2 }}%
                            {% endif %}
                        </td>
                        <td>{{ stat.sent_offers }}</td>
                        <td>{{ stat.sold_offers }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Fifth Section: Most Wanted Locations -->
        <div class="section">
            <h3 class="section-title">Most Wanted Locations for {{ selected_month }}</h3>
            <table class="table table-striped table-bordered shadow-sm">
                <thead class="thead-yellow">
                    <tr>
                        <th>Destination</th>
                        <th>Number of Requests</th>
                        <th>Conversion Rate</td>
                    </tr>
                </thead>
                <tbody>
                    {% for destination in top_destinations %}
                    <tr>
                        <td>{{ destination.destination }}</td>
                        <td>{{ destination.destination_count }}</td>
                        <td>{{ destination.conversion_rate|floatformat:2 }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
